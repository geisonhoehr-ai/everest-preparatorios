# üêõ BUGS E SOLU√á√ïES - EVEREST PREPARAT√ìRIOS

## üéØ **VIS√ÉO GERAL:**

Este documento registra todos os bugs encontrados, suas causas, solu√ß√µes implementadas e status atual. Serve como refer√™ncia para o Agente de IA resolver problemas similares.

## üö® **BUGS CR√çTICOS RESOLVIDOS:**

### **1. Erro ao Inserir Membro**
```typescript
// ‚ùå ERRO ORIGINAL
Error: ‚ùå [MEMBROS] Erro ao inserir membro: {}

// üîç CAUSA
- Tabela `members` com schema incorreto
- Coluna `full_name` n√£o existia
- RLS policies n√£o configuradas

// ‚úÖ SOLU√á√ÉO
- Recriar tabela com schema correto
- Adicionar todas as colunas necess√°rias
- Configurar RLS policies

// üìù SCRIPT DE CORRE√á√ÉO
-- scripts/246_fix_members_table_structure.sql
DROP TABLE IF EXISTS members;
CREATE TABLE members (
  id SERIAL PRIMARY KEY,
  email TEXT NOT NULL UNIQUE,
  full_name TEXT NOT NULL,
  phone TEXT,
  cpf_cnpj TEXT,
  status TEXT DEFAULT 'active',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_seen_at TIMESTAMP WITH TIME ZONE
);

-- RLS Policies
ALTER TABLE members ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable read access for authenticated users" ON members
  FOR SELECT USING (auth.role() = 'authenticated');
-- ... outras pol√≠ticas
```

### **2. Erro ao Definir Role**
```typescript
// ‚ùå ERRO ORIGINAL
Error: ‚ùå [MEMBROS] Erro ao definir role: {}

// üîç CAUSA
- Tabela `user_roles` com `user_uuid` como UUID
- Aplica√ß√£o tentando inserir email (TEXT)
- Incompatibilidade de tipos

// ‚úÖ SOLU√á√ÉO
- Alterar `user_uuid` para TEXT
- Atualizar todas as queries
- Manter consist√™ncia com email

// üìù SCRIPT DE CORRE√á√ÉO
-- scripts/251_fix_user_roles_table.sql
ALTER TABLE user_roles ALTER COLUMN user_uuid TYPE TEXT;
-- Configurar RLS policies
```

### **3. Erro ao Criar Perfil Inicial**
```typescript
// ‚ùå ERRO ORIGINAL
Error: Erro ao criar perfil inicial: {}

// üîç CAUSA
- Tabela `student_profiles` com `user_uuid` como UUID
- Mesmo problema de incompatibilidade de tipos
- RLS n√£o configurado

// ‚úÖ SOLU√á√ÉO
- Alterar `user_uuid` para TEXT
- Configurar RLS policies
- Garantir inser√ß√£o autom√°tica

// üìù SCRIPT DE CORRE√á√ÉO
-- scripts/254_fix_student_profiles_table.sql
ALTER TABLE student_profiles ALTER COLUMN user_uuid TYPE TEXT;
-- Configurar RLS policies
```

### **4. Menu Admin N√£o Aparecendo**
```typescript
// ‚ùå ERRO ORIGINAL
- Menu admin n√£o aparecendo para professores
- Perfil mostrando "Estudante" para professores
- Sess√£o n√£o persistente

// üîç CAUSA
- Middleware mostrando "Sess√£o: false"
- useAuth hook n√£o detectando role corretamente
- Sidebar n√£o renderizando menu correto

// ‚úÖ SOLU√á√ÉO
- Corrigir middleware para detectar sess√£o
- Melhorar useAuth hook
- Atualizar SidebarNav com logs de debug

// üìù C√ìDIGO CORRIGIDO
// lib/auth-simple.ts
const { data: roleData } = await supabase
  .from('user_roles')
  .select('role')
  .eq('user_uuid', session.user.email)  // Usar email, n√£o ID
  .single()

// components/sidebar-nav.tsx
console.log('üîç [SIDEBAR] User:', user)
console.log('üë®‚Äçüè´ [SIDEBAR] Mostrando menu de professor/admin')
```

## üîß **BUGS DE PERFORMANCE:**

### **1. Carregamento Lento de P√°ginas**
```typescript
// ‚ùå PROBLEMA
- P√°ginas demorando para carregar
- Queries n√£o otimizadas
- Bundle size grande

// ‚úÖ SOLU√á√ïES
- Implementar lazy loading
- Otimizar queries com √≠ndices
- Code splitting por rota
- Implementar cache

// üìù IMPLEMENTA√á√ÉO
// Lazy loading de componentes
const LazyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <LoadingSpinner />
})

// Otimizar queries
const { data } = await supabase
  .from('members')
  .select('id, email, full_name, status')  // Selecionar apenas campos necess√°rios
  .eq('status', 'active')
  .order('created_at', { ascending: false })
  .limit(50)
```

### **2. Memory Leaks**
```typescript
// ‚ùå PROBLEMA
- Componentes n√£o limpando listeners
- useEffect sem cleanup
- Event listeners acumulando

// ‚úÖ SOLU√á√ïES
- Sempre limpar listeners no useEffect
- Usar AbortController para requests
- Implementar cleanup functions

// üìù IMPLEMENTA√á√ÉO
useEffect(() => {
  const controller = new AbortController()
  
  const fetchData = async () => {
    try {
      const response = await fetch('/api/data', {
        signal: controller.signal
      })
      // Processar dados
    } catch (error) {
      if (error.name !== 'AbortError') {
        console.error('Erro:', error)
      }
    }
  }
  
  fetchData()
  
  return () => {
    controller.abort()
  }
}, [])
```

## üé® **BUGS DE UI/UX:**

### **1. Componentes N√£o Responsivos**
```typescript
// ‚ùå PROBLEMA
- Layout quebrado em mobile
- Tabelas com overflow
- Sidebar n√£o adapt√°vel

// ‚úÖ SOLU√á√ïES
- Implementar mobile-first design
- Usar classes responsivas do Tailwind
- Testar em diferentes breakpoints

// üìù IMPLEMENTA√á√ÉO
// Tabela responsiva
<div className="overflow-x-auto">
  <Table>
    <TableHeader>
      <TableRow>
        <TableHead className="hidden md:table-cell">Nome</TableHead>
        <TableHead>Email</TableHead>
        <TableHead className="hidden lg:table-cell">Status</TableHead>
      </TableRow>
    </TableHeader>
  </Table>
</div>

// Sidebar responsiva
<div className={cn(
  "fixed inset-y-0 left-0 z-50 w-64 bg-background border-r transform transition-transform duration-300 md:hidden",
  mobileOpen ? "translate-x-0" : "-translate-x-full"
)}>
```

### **2. Estados de Loading Ausentes**
```typescript
// ‚ùå PROBLEMA
- Componentes sem loading state
- Interface travada durante carregamento
- UX ruim

// ‚úÖ SOLU√á√ïES
- Sempre implementar loading states
- Usar skeletons ou spinners
- Feedback visual para a√ß√µes

// üìù IMPLEMENTA√á√ÉO
export function MyComponent() {
  const { data, isLoading, error } = useQuery()
  
  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-8">
        <LoadingSpinner />
        <span className="ml-2">Carregando...</span>
      </div>
    )
  }
  
  if (error) {
    return (
      <div className="text-center p-8">
        <p className="text-destructive">Erro ao carregar dados</p>
        <Button onClick={() => refetch()}>Tentar novamente</Button>
      </div>
    )
  }
  
  return <div>{/* Conte√∫do */}</div>
}
```

## üóÑÔ∏è **BUGS DE BANCO DE DADOS:**

### **1. RLS Policies Quebradas**
```sql
-- ‚ùå PROBLEMA
-- Pol√≠ticas RLS n√£o configuradas
-- Acesso negado a dados

-- ‚úÖ SOLU√á√ÉO
-- Configurar pol√≠ticas para todas as tabelas
ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable read access for authenticated users" ON table_name
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Enable insert for authenticated users" ON table_name
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');
```

### **2. Relacionamentos Quebrados**
```sql
-- ‚ùå PROBLEMA
-- Foreign keys com tipos incompat√≠veis
-- Queries falhando

-- ‚úÖ SOLU√á√ÉO
-- Verificar e corrigir tipos de dados
-- Garantir consist√™ncia entre tabelas

-- Exemplo: user_uuid como TEXT em todas as tabelas
ALTER TABLE user_roles ALTER COLUMN user_uuid TYPE TEXT;
ALTER TABLE members ALTER COLUMN email TYPE TEXT;
ALTER TABLE student_profiles ALTER COLUMN user_uuid TYPE TEXT;
```

## üîç **BUGS DE AUTENTICA√á√ÉO:**

### **1. Sess√£o N√£o Persistente**
```typescript
// ‚ùå PROBLEMA
// Middleware mostrando "Sess√£o: false"
// Usu√°rio sendo deslogado

// ‚úÖ SOLU√á√ÉO
// Verificar configura√ß√£o do Supabase
// Implementar refresh token
// Melhorar middleware

// üìù IMPLEMENTA√á√ÉO
// middleware.ts
export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  const supabase = createMiddlewareClient({ req, res })

  try {
    const { data: { session }, error } = await supabase.auth.getSession()
    
    console.log('üîç [MIDDLEWARE] Rota:', req.nextUrl.pathname, 'Sess√£o:', !!session)
    
    // Permitir acesso a todas as rotas (n√£o for√ßar login)
    return res
    
  } catch (error) {
    console.error('‚ùå [MIDDLEWARE] Erro:', error)
    return res
  }
}
```

### **2. Role N√£o Detectado**
```typescript
// ‚ùå PROBLEMA
// Menu admin n√£o aparecendo
// Role n√£o sendo carregado

// ‚úÖ SOLU√á√ÉO
// Verificar tabela user_roles
// Usar email em vez de UUID
// Adicionar logs de debug

// üìù IMPLEMENTA√á√ÉO
// lib/auth-simple.ts
const { data: roleData, error: roleError } = await supabase
  .from('user_roles')
  .select('role')
  .eq('user_uuid', session.user.email)  // Usar email
  .single()

if (roleError) {
  console.warn('‚ö†Ô∏è [AUTH] Erro ao buscar role:', roleError)
}
```

## üß™ **SCRIPTS DE DIAGN√ìSTICO:**

### **1. Verificar Estrutura do Banco**
```javascript
// scripts/verify_database.js
const { data: tables } = await supabase
  .from('information_schema.tables')
  .select('table_name')
  .eq('table_schema', 'public')

console.log('üìã Tabelas encontradas:', tables)
```

### **2. Testar Autentica√ß√£o**
```javascript
// scripts/test_auth.js
const { data, error } = await supabase.auth.signInWithPassword({
  email: 'professor@teste.com',
  password: '123456'
})

if (error) {
  console.error('‚ùå Erro no login:', error)
} else {
  console.log('‚úÖ Login bem-sucedido:', data.user.email)
}
```

### **3. Verificar Role**
```javascript
// scripts/test_role.js
const { data: roleData, error } = await supabase
  .from('user_roles')
  .select('role')
  .eq('user_uuid', 'professor@teste.com')
  .single()

if (error) {
  console.error('‚ùå Erro ao buscar role:', error)
} else {
  console.log('‚úÖ Role encontrado:', roleData.role)
}
```

## üìä **M√âTRICAS DE BUGS:**

### **Logs Importantes:**
```typescript
// Sempre logar erros com contexto
console.error('‚ùå [COMPONENTE] Erro:', error)
console.warn('‚ö†Ô∏è [COMPONENTE] Aviso:', warning)
console.log('üîç [COMPONENTE] Debug:', data)
```

### **Monitoramento:**
- **Taxa de erro por componente**
- **Tempo de resolu√ß√£o de bugs**
- **Bugs recorrentes**
- **Performance impact**

## üöÄ **PREVEN√á√ÉO DE BUGS:**

### **1. Padr√µes de C√≥digo**
```typescript
// Sempre usar TypeScript
interface User {
  id: string
  email: string
  role: 'student' | 'teacher' | 'admin'
}

// Sempre tratar erros
try {
  const result = await apiCall()
  return { success: true, data: result }
} catch (error) {
  console.error('Erro:', error)
  return { success: false, error: error.message }
}
```

### **2. Testes Automatizados**
```typescript
// Testar componentes
test('renders correctly', () => {
  render(<MyComponent />)
  expect(screen.getByText('Texto')).toBeInTheDocument()
})

// Testar fun√ß√µes
test('handles error correctly', () => {
  const result = handleError(new Error('Test error'))
  expect(result.success).toBe(false)
})
```

### **3. Code Review**
- **Verificar tipos TypeScript**
- **Testar responsividade**
- **Validar acessibilidade**
- **Verificar performance**

## üìù **CHECKLIST DE RESOLU√á√ÉO:**

### **Ao Encontrar um Bug:**
1. **Reproduzir** o problema
2. **Identificar** a causa raiz
3. **Implementar** a solu√ß√£o
4. **Testar** a corre√ß√£o
5. **Documentar** a solu√ß√£o
6. **Prevenir** recorr√™ncia

### **Ao Implementar Solu√ß√£o:**
1. **Verificar** compatibilidade
2. **Testar** em diferentes cen√°rios
3. **Adicionar** logs de debug
4. **Atualizar** documenta√ß√£o
5. **Criar** script de teste

---

**üêõ DOCUMENTA√á√ÉO COMPLETA DE BUGS E SOLU√á√ïES DO EVEREST PREPARAT√ìRIOS** 